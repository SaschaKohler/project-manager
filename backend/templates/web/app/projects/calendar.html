{% extends "web/app/layout.html" %}
{% load i18n %}
{% get_current_language as CURRENT_LANGUAGE %}

{% block title %}{{ project.title }} · {% trans "Calendar" %} · Project Manager{% endblock %}

{% block content %}
<div class="flex items-end justify-between gap-6">
  <div class="min-w-0">
    <div class="text-sm text-zinc-400">{{ project.title }}</div>
    <h1 class="mt-1 text-3xl font-semibold tracking-tight">{% trans "Calendar" %}</h1>
  </div>
  <div class="flex items-center gap-2">
    <a href="{% url 'web:tasks' %}?project={{ project.id }}"
       class="rounded-lg border border-zinc-800 bg-zinc-900/40 px-3 py-2 text-sm hover:bg-zinc-900">
      {% trans "Kanban" %}
    </a>
  </div>
</div>

<div class="mt-8 grid grid-cols-1 lg:grid-cols-4 gap-4">
  <div class="lg:col-span-1 rounded-2xl border border-zinc-800 bg-zinc-900/40 p-5">
    <div class="text-sm text-zinc-400">{% trans "Unscheduled tasks" %}</div>

    {% if in_progress_unscheduled %}
      <div class="mt-4">
        <div class="text-xs uppercase tracking-wider text-zinc-500">{% trans "In progress (unscheduled)" %}</div>
        <div class="mt-2 space-y-2">
          {% for task in in_progress_unscheduled %}
            <div class="rounded-xl border border-emerald-500/30 bg-emerald-500/10 p-3 text-sm"
                 data-task-id="{{ task.id }}"
                 data-title="{{ task.title|escape }}"
                 data-duration-minutes="{{ task.duration_minutes|default_if_none:60 }}">
              <div class="font-medium truncate">{{ task.title }}</div>
              <div class="mt-1 text-xs text-zinc-400 truncate">{% trans "Assigned to" %} {{ task.assigned_to.email }}</div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="mt-5 text-xs uppercase tracking-wider text-zinc-500">{% trans "Backlog" %}</div>
    <div id="unscheduled" class="mt-4 space-y-2">
      {% for task in unscheduled_tasks %}
        <div class="rounded-xl border border-zinc-800 bg-zinc-950/40 p-3 text-sm"
             data-task-id="{{ task.id }}"
             data-title="{{ task.title|escape }}"
             data-duration-minutes="{{ task.duration_minutes|default_if_none:60 }}">
          <div class="font-medium truncate">{{ task.title }}</div>
          <div class="mt-1 text-xs text-zinc-500 truncate">{% trans "Assigned to" %} {{ task.assigned_to.email }}</div>
        </div>
      {% empty %}
        <div class="mt-3 text-sm text-zinc-400">{% trans "No unscheduled tasks." %}</div>
      {% endfor %}
    </div>
  </div>

  <div class="lg:col-span-3 rounded-2xl border border-zinc-800 bg-zinc-900/30 overflow-hidden">
    <div class="px-5 py-4 border-b border-zinc-800 flex items-center justify-between">
      <div class="text-sm text-zinc-200 font-medium">{% trans "Schedule" %}</div>
      <div class="text-xs text-zinc-500">{{ project.start_date|date:"Y-m-d" }} → {{ project.end_date|date:"Y-m-d" }}</div>
    </div>
    <div class="px-5 py-3 border-b border-zinc-800 flex flex-wrap items-center justify-between gap-3">
      <div class="text-xs uppercase tracking-wider text-zinc-500">{% trans "Filters" %}</div>
      <div class="flex flex-wrap items-center gap-3">
        <div class="flex items-center gap-2">
          <label for="filter-status" class="text-sm text-zinc-400">{% trans "Status" %}</label>
          <select id="filter-status"
                  class="rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">{% trans "All statuses" %}</option>
            <option value="TODO">{% trans "Todo" %}</option>
            <option value="IN_PROGRESS">{% trans "In progress" %}</option>
            <option value="DONE">{% trans "Done" %}</option>
          </select>
        </div>
        <label class="flex items-center gap-2 text-sm text-zinc-400 select-none">
          <input id="filter-show-done" type="checkbox" checked class="rounded border-zinc-700 bg-zinc-950" />
          {% trans "Show done" %}
        </label>
      </div>
    </div>
    <div class="p-4">
      <div id="calendar"></div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
<style>
  #calendar {
    --fc-border-color: rgba(63, 63, 70, 0.7);
    --fc-page-bg-color: transparent;
    --fc-neutral-bg-color: rgba(24, 24, 27, 0.55);
    --fc-neutral-text-color: rgb(161, 161, 170);
    --fc-today-bg-color: rgba(99, 102, 241, 0.10);
    --fc-event-bg-color: rgba(99, 102, 241, 0.85);
    --fc-event-border-color: rgba(99, 102, 241, 1);
    --fc-event-text-color: rgb(244, 244, 245);
  }

  #calendar .fc-theme-standard td,
  #calendar .fc-theme-standard th,
  #calendar .fc-scrollgrid {
    border-color: rgba(63, 63, 70, 0.7);
  }

  #calendar .fc-col-header-cell-cushion,
  #calendar .fc-timegrid-axis-cushion,
  #calendar .fc-timegrid-slot-label-cushion,
  #calendar .fc-daygrid-day-number {
    color: rgb(212, 212, 216);
  }

  #calendar .fc-timegrid-slot {
    background: rgba(9, 9, 11, 0.18);
  }

  #calendar .fc-timegrid-slot-minor {
    border-top-style: dotted;
    border-top-color: rgba(63, 63, 70, 0.45);
  }

  #calendar .fc-toolbar-title {
    color: rgb(244, 244, 245);
    font-weight: 600;
  }

  #calendar .fc-button {
    background: rgba(39, 39, 42, 0.55);
    border: 1px solid rgba(63, 63, 70, 0.9);
    color: rgb(228, 228, 231);
    box-shadow: none;
    text-transform: none;
  }

  #calendar .fc-button:hover {
    background: rgba(39, 39, 42, 0.75);
  }

  #calendar .fc-button-primary:not(:disabled).fc-button-active,
  #calendar .fc-button-primary:not(:disabled):active {
    background: rgba(99, 102, 241, 0.22);
    border-color: rgba(99, 102, 241, 0.65);
    color: rgb(244, 244, 245);
  }

  #calendar .fc-event {
    border-radius: 10px;
    padding: 2px 6px;
  }

  #calendar .fc-event:hover {
    filter: brightness(1.05);
  }

  #calendar .fc-day-today {
    background: rgba(99, 102, 241, 0.10) !important;
  }

  #calendar .fc-highlight {
    background: rgba(99, 102, 241, 0.12);
  }
 </style>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js"></script>
<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function showToast(message) {
    const el = document.getElementById('toast');
    if (!el) return;
    el.textContent = message;
    el.classList.remove('opacity-0', 'pointer-events-none');
    el.classList.add('opacity-100');
    clearTimeout(el._hideTimer);
    el._hideTimer = setTimeout(() => {
      el.classList.add('opacity-0', 'pointer-events-none');
      el.classList.remove('opacity-100');
    }, 2200);
  }

  async function postSchedule(taskId, startStr, endStr) {
    const body = new URLSearchParams();
    body.set('start', startStr);
    if (endStr) body.set('end', endStr);

    const url = `{% url 'web:tasks_schedule' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', taskId);

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body,
    });

    if (!res.ok) throw new Error('schedule_failed');
  }

  async function postUnschedule(taskId) {
    const body = new URLSearchParams();
    body.set('clear_due_date', '1');

    const url = `{% url 'web:tasks_unschedule' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', taskId);

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body,
    });

    if (!res.ok) throw new Error('unschedule_failed');
  }

  async function handleUnschedule(calendar, event) {
    const ok = confirm('{% trans "Unschedule this task?" %}');
    if (!ok) return;

    try {
      await postUnschedule(event.id);
      event.remove();

      const backlog = document.getElementById('unscheduled');
      if (backlog) {
        const title = (event.extendedProps && event.extendedProps.task_title) || event.title || 'Task';
        const mins = (event.extendedProps && event.extendedProps.duration_minutes) || 60;

        const el = document.createElement('div');
        el.className = 'rounded-xl border border-zinc-800 bg-zinc-950/40 p-3 text-sm';
        el.dataset.taskId = event.id;
        el.dataset.title = title;
        el.dataset.durationMinutes = String(mins);

        el.innerHTML = `
          <div class="font-medium truncate"></div>
          <div class="mt-1 text-xs text-zinc-500 truncate"></div>
        `;

        el.querySelector('div.font-medium').textContent = title;
        const assigned = (event.extendedProps && event.extendedProps.assigned_to_email) || '';
        el.querySelector('div.text-xs').textContent = assigned ? (`{% trans "Assigned to" %} ${assigned}`) : '';

        backlog.prepend(el);
      }

      calendar.refetchEvents();
    } catch (err) {
      showToast('{% trans "Could not unschedule task. Please try again." %}');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const unscheduledEl = document.getElementById('unscheduled');
    if (unscheduledEl && FullCalendar.Draggable) {
      new FullCalendar.Draggable(unscheduledEl, {
        itemSelector: '[data-task-id]',
        eventData: function(eventEl) {
          const mins = parseInt(eventEl.dataset.durationMinutes || '60', 10);
          const safe = Number.isFinite(mins) && mins > 0 ? mins : 60;
          const hh = String(Math.floor(safe / 60)).padStart(2, '0');
          const mm = String(safe % 60).padStart(2, '0');
          return {
            id: eventEl.dataset.taskId,
            title: eventEl.dataset.title || 'Task',
            duration: `${hh}:${mm}`
          };
        }
      });
    }

    const calEl = document.getElementById('calendar');
    const statusEl = document.getElementById('filter-status');
    const showDoneEl = document.getElementById('filter-show-done');

    const rawLocale = '{{ CURRENT_LANGUAGE }}' || 'en';
    const locale = rawLocale.toLowerCase().startsWith('de') ? 'de' : 'en';
    const calendar = new FullCalendar.Calendar(calEl, {
      initialView: 'timeGridWeek',
      height: 'auto',
      editable: true,
      droppable: true,
      selectable: false,
      nowIndicator: true,
      timeZone: 'local',
      locale: locale,
      buttonText: {
        today: '{% trans "Today" %}',
        month: '{% trans "Month" %}',
        week: '{% trans "Week" %}',
        day: '{% trans "Day" %}',
      },
      allDayText: '{% trans "All day" %}',
      firstDay: 1,
      weekNumbers: true,
      slotMinTime: '06:00:00',
      slotMaxTime: '22:00:00',
      scrollTime: '08:00:00',
      slotDuration: '00:30:00',
      eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
      slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
      dayHeaderFormat: { weekday: 'short', day: '2-digit', month: '2-digit' },
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      eventSources: [
        {
          url: '{% url "web:project_calendar_events" project.id %}',
          method: 'GET'
          ,extraParams: () => {
            const params = {};
            const status = (statusEl && statusEl.value) ? statusEl.value : '';
            if (status) params.status = status;
            const showDone = showDoneEl ? showDoneEl.checked : true;
            if (!showDone) params.hide_done = '1';
            return params;
          }
        }
      ],
      eventReceive: async (info) => {
        try {
          await postSchedule(info.event.id, info.event.startStr, info.event.endStr);
          const el = document.querySelector(`#unscheduled [data-task-id="${info.event.id}"]`);
          if (el) el.remove();
        } catch (e) {
          info.revert();
          showToast('{% trans "Could not schedule task. Please try again." %}');
        }
      },
      eventDrop: async (info) => {
        try {
          await postSchedule(info.event.id, info.event.startStr, info.event.endStr);
        } catch (e) {
          info.revert();
          showToast('{% trans "Could not schedule task. Please try again." %}');
        }
      },
      eventResize: async (info) => {
        try {
          await postSchedule(info.event.id, info.event.startStr, info.event.endStr);
        } catch (e) {
          info.revert();
          showToast('{% trans "Could not schedule task. Please try again." %}');
        }
      },
      eventClick: async (info) => {
        if (info.jsEvent && info.jsEvent.altKey) {
          info.jsEvent.preventDefault();
          await handleUnschedule(calendar, info.event);
        }
      },
      eventDidMount: (info) => {
        info.el.oncontextmenu = (e) => {
          e.preventDefault();
          handleUnschedule(calendar, info.event);
          return false;
        };

        info.el.addEventListener('contextmenu', (e) => {
          e.preventDefault();
        }, { capture: true });
      },
    });

    calendar.render();

    function refetch() {
      calendar.refetchEvents();
    }
    if (statusEl) statusEl.addEventListener('change', refetch);
    if (showDoneEl) showDoneEl.addEventListener('change', refetch);
  });
</script>

<div id="toast"
     class="fixed bottom-4 left-1/2 -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950/90 px-4 py-2 text-sm text-zinc-200 shadow-lg opacity-0 pointer-events-none transition-opacity">
</div>
{% endblock %}
