{% load i18n %}
<div class="rounded-xl border border-zinc-800/70 bg-zinc-950/35 p-4 shadow-sm hover:bg-zinc-950/45 transition {% if running_task_ids and task.id in running_task_ids %}border-emerald-500/60 bg-emerald-950/20{% endif %}"
     data-task-id="{{ task.id }}"
     data-move-url="{% url 'web:tasks_move' task.id %}"
     {% if task.running_started_at %}data-running-started-at="{{ task.running_started_at|date:'c' }}"{% endif %}>
  <div class="flex items-start gap-3">
    <div class="drag-handle select-none pt-0.5 text-zinc-500 cursor-grab active:cursor-grabbing">⋮⋮</div>
    <div class="min-w-0 flex-1">
      {% include "web/app/tasks/_task_title.html" with task=task %}
      <div class="mt-1 text-xs text-zinc-500 truncate">{{ task.project.title }}</div>

      {% if task.idea_card or task.links.all %}
        <div class="mt-1 flex flex-wrap items-center gap-2 text-xs text-zinc-400">
          {% if task.idea_card %}
            <a href="{% url 'web:board_card_detail' task.idea_card.id %}" class="underline hover:text-zinc-200">
              {% trans "Idea" %}: {{ task.idea_card.title }}
            </a>
          {% endif %}
          {% if task.links.all %}
            {% with l=task.links.all.0 %}
              <a href="{{ l.url }}" target="_blank" rel="noopener" class="underline hover:text-zinc-200 truncate max-w-[220px]">
                {% if l.title %}{{ l.title }}{% else %}{{ l.url }}{% endif %}
              </a>
            {% endwith %}
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
  <div class="mt-3 flex items-center justify-between text-xs text-zinc-500">
    <div class="truncate">
      {% if members %}
        <label class="sr-only" for="assign-{{ task.id }}">{% trans "Assigned to" %}</label>
        <select id="assign-{{ task.id }}"
                name="assigned_to"
                class="max-w-[220px] rounded-md border border-zinc-800/70 bg-zinc-900/35 px-2 py-1 outline-none focus:ring-2 focus:ring-indigo-500"
                hx-post="{% url 'web:tasks_assign' task.id %}"
                hx-trigger="change"
                hx-target="closest [data-task-id]"
                hx-swap="outerHTML">
          <option value="">{% trans "Me" %}</option>
          {% for m in members %}
            <option value="{{ m.user.id }}" {% if task.assigned_to_id == m.user.id %}selected{% endif %}>{{ m.user.email }}</option>
          {% endfor %}
        </select>
      {% else %}
        {% trans "Assigned to" %} {{ task.assigned_to.email }}
      {% endif %}
    </div>
    <div class="flex items-center gap-2">
      <div class="hidden sm:block text-zinc-500">{{ task.tracked_human }}</div>
      <div class="hidden sm:block font-mono text-zinc-400" data-live-timer></div>
      <button class="rounded-md border border-zinc-800/70 bg-zinc-900/35 px-2 py-1 hover:bg-zinc-900/55 transition"
              hx-post="{% url 'web:tasks_timer' task.id %}"
              hx-target="closest [data-task-id]"
              hx-swap="outerHTML">
        {% if running_task_ids and task.id in running_task_ids %}{% trans "Stop" %}{% else %}{% trans "Start" %}{% endif %}
      </button>
      <button class="rounded-md border border-zinc-800/70 bg-zinc-900/35 px-2 py-1 hover:bg-zinc-900/55 transition"
              hx-post="{% url 'web:tasks_toggle' task.id %}"
              hx-target="closest [data-task-id]"
              hx-swap="outerHTML">
        {% if task.status == 'DONE' %}{% trans "Undo" %}{% else %}{% trans "Done" %}{% endif %}
      </button>
    </div>
  </div>

  {% if task.status == 'DONE' %}
    <details class="mt-3" data-time-accordion>
      <summary class="cursor-pointer select-none text-xs text-zinc-400 hover:text-zinc-200"
               hx-get="{% url 'web:tasks_time_entries' task.id %}"
               hx-trigger="click once"
               hx-target="#time-entries-{{ task.id }}"
               hx-swap="innerHTML">
        {% trans "Time entries" %}
      </summary>
      <div id="time-entries-{{ task.id }}" class="mt-2"></div>
    </details>
  {% endif %}
</div>
