{% extends "web/app/layout.html" %}
{% load i18n %}

{% block title %}{% trans "Tasks" %} · Project Manager{% endblock %}

{% block content %}
<div class="flex items-end justify-between gap-6">
   <div>
     <h1 class="text-3xl font-semibold tracking-tight">{% trans "Tasks" %}</h1>
     <p class="mt-2 text-sm text-zinc-300">{% trans "Small wins, compounding daily." %}</p>
   </div>
</div>

<!-- Search and Filters -->
<div class="mt-6">
  <div class="flex flex-col sm:flex-row gap-3 mb-4">
    <div class="flex-1 relative">
      <input type="text"
             id="task-search"
             placeholder="{% trans 'Search tasks by title, description, or assignee...' %}"
             class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-4 py-2 pl-10 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
      <svg class="absolute left-3 top-2.5 w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </div>
    <button id="filters-toggle" class="rounded-lg bg-zinc-900 border border-zinc-800 px-4 py-2 text-sm hover:bg-zinc-800 transition">
      {% trans "Filters" %}
    </button>
    <button id="bulk-select-toggle" class="rounded-lg bg-zinc-900 border border-zinc-800 px-4 py-2 text-sm hover:bg-zinc-800 transition hidden">
      {% trans "Select" %}
    </button>
  </div>

  <!-- Active filters -->
  <div id="active-filters" class="flex flex-wrap gap-2 mb-4 hidden">
    <!-- Filter tags will be added here -->
  </div>

  <!-- Filters panel (hidden by default) -->
  <div id="filters-panel" class="hidden rounded-lg border border-zinc-800 bg-zinc-900/50 p-4 mb-4">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm text-zinc-400 mb-2">{% trans "Assignee" %}</label>
        <select id="filter-assignee" multiple class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm">
          {% for m in members %}
            <option value="{{ m.user.id }}">{{ m.user.email }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm text-zinc-400 mb-2">{% trans "Priority" %}</label>
        <select id="filter-priority" multiple class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm">
          <option value="HIGH">{% trans "High" %}</option>
          <option value="MEDIUM">{% trans "Medium" %}</option>
          <option value="LOW">{% trans "Low" %}</option>
        </select>
      </div>
      <div>
        <label class="block text-sm text-zinc-400 mb-2">{% trans "Due Date" %}</label>
        <div class="flex gap-2">
          <input type="date" id="filter-due-from" class="flex-1 rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm">
          <input type="date" id="filter-due-to" class="flex-1 rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm">
        </div>
      </div>
      <div>
        <label class="block text-sm text-zinc-400 mb-2">{% trans "Status" %}</label>
        <select id="filter-status" multiple class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm">
          <option value="TODO">{% trans "Todo" %}</option>
          <option value="IN_PROGRESS">{% trans "In Progress" %}</option>
          <option value="DONE">{% trans "Done" %}</option>
        </select>
      </div>
    </div>
    <div class="flex justify-end gap-2 mt-4">
      <button id="clear-filters" class="rounded-lg border border-zinc-800 bg-zinc-900 px-4 py-2 text-sm hover:bg-zinc-800">{% trans "Clear" %}</button>
      <button id="apply-filters" class="rounded-lg bg-indigo-600 hover:bg-indigo-500 px-4 py-2 text-sm">{% trans "Apply" %}</button>
    </div>
  </div>
</div>

<!-- View tabs and project filter -->
<div class="flex flex-wrap items-center justify-between gap-3">
  <div class="flex flex-wrap items-center gap-2">
  <a href="?view=all{% if active_project %}&project={{ active_project.id }}{% endif %}"
     class="rounded-lg px-3 py-1.5 text-sm border transition {% if active_view == 'all' %}border-indigo-500 bg-indigo-600/20 text-zinc-100{% else %}border-zinc-800 bg-zinc-900/40 text-zinc-300 hover:bg-zinc-900{% endif %}">
    {% trans "All" %}
  </a>
  <a href="?view=inbox{% if active_project %}&project={{ active_project.id }}{% endif %}"
     class="rounded-lg px-3 py-1.5 text-sm border transition {% if active_view == 'inbox' %}border-indigo-500 bg-indigo-600/20 text-zinc-100{% else %}border-zinc-800 bg-zinc-900/40 text-zinc-300 hover:bg-zinc-900{% endif %}">
    {% trans "Inbox" %}
  </a>
  <a href="?view=today{% if active_project %}&project={{ active_project.id }}{% endif %}"
     class="rounded-lg px-3 py-1.5 text-sm border transition {% if active_view == 'today' %}border-indigo-500 bg-indigo-600/20 text-zinc-100{% else %}border-zinc-800 bg-zinc-900/40 text-zinc-300 hover:bg-zinc-900{% endif %}">
    {% trans "Today" %}
  </a>
  {% if active_project %}
    <a href="{% url 'web:project_calendar' active_project.id %}"
       class="rounded-lg px-3 py-1.5 text-sm border transition border-zinc-800 bg-zinc-900/40 text-zinc-300 hover:bg-zinc-900">
      {% trans "Calendar" %}
    </a>
  {% endif %}
  <a href="{% url 'web:task_automations' %}"
     class="rounded-lg px-3 py-1.5 text-sm border transition border-purple-600 bg-purple-600/20 text-purple-300 hover:bg-purple-600/30">
    <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
    </svg>
    {% trans "Automations" %}
  </a>
  <a href="{% url 'web:tasks_archive' %}"
     class="rounded-lg px-3 py-1.5 text-sm border transition border-zinc-800 bg-zinc-900/40 text-zinc-300 hover:bg-zinc-900">
    <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
    </svg>
    {% trans "Archive" %}
  </a>
  </div>

  <form method="get" class="flex items-center gap-2">
    <input type="hidden" name="view" value="{{ active_view }}" />
    <label class="text-sm text-zinc-400">{% trans "Project" %}</label>
    <select name="project"
            onchange="this.form.submit()"
            class="rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
      <option value="">{% trans "All projects" %}</option>
      {% for p in projects %}
        <option value="{{ p.id }}" {% if active_project and active_project.id == p.id %}selected{% endif %}>{{ p.title }}</option>
      {% endfor %}
    </select>
  </form>
</div>

<div class="mt-8 grid grid-cols-1 lg:grid-cols-4 gap-4">
  <div class="lg:col-span-1 rounded-2xl border border-zinc-800/70 bg-zinc-900/25 p-5 backdrop-blur">
    <div class="text-sm text-zinc-400">{% trans "Quick add" %}</div>

    {% if not projects %}
      <div class="mt-4 text-sm text-zinc-300">{% trans "Create a project first." %}</div>
      <a href="{% url 'web:projects' %}" class="mt-4 inline-flex rounded-lg bg-indigo-600 hover:bg-indigo-500 transition px-3 py-2 text-sm font-medium">{% trans "Go to projects" %}</a>
    {% else %}
      <form id="task-create-form" class="mt-4 space-y-3"
            hx-post="{% url 'web:tasks_create' %}"
            hx-target="#col-todo"
            hx-swap="afterbegin"
            hx-on::after-request="this.reset()">
        {% csrf_token %}
        <div id="task-error-message" class="hidden rounded-lg border border-red-800 bg-red-900/20 px-3 py-2 text-sm text-red-300"></div>
        <div>
          <label class="block text-xs text-zinc-400 mb-2">{% trans "Project" %}</label>
          <select name="project_id" required class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
            {% for p in projects %}
              {% if not p.is_archived %}
                <option value="{{ p.id }}">{{ p.title }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs text-zinc-400 mb-2">{% trans "Title" %}</label>
          <input name="title" required placeholder="{% trans 'e.g. Write landing copy' %}"
                 class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <div>
          <label class="block text-xs text-zinc-400 mb-2">{% trans "Assigned to" %}</label>
          <select name="assigned_to" class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">{% trans "Me" %}</option>
            {% for m in members %}
              <option value="{{ m.user.id }}">{{ m.user.email }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="block text-xs text-zinc-400 mb-2">{% trans "Idea" %}</label>
          <select name="idea_card_id" class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="">{% trans "No idea" %}</option>
            {% for c in idea_cards %}
              <option value="{{ c.id }}">{{ c.column.board.title }} · {{ c.title }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs text-zinc-400 mb-2">{% trans "Link" %}</label>
            <input name="link_url" type="url" placeholder="https://..."
                   class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-xs text-zinc-400 mb-2">{% trans "Link title" %}</label>
            <input name="link_title" placeholder="{% trans 'optional' %}"
                   class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
        </div>

        <div>
          <label class="block text-xs text-zinc-400 mb-2">{% trans "Due date" %}</label>
          <input name="due_date" type="date"
                 class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>

        <div class="space-y-3">
          <div class="flex items-center">
            <input type="checkbox" id="is_recurring" name="is_recurring" class="rounded border-zinc-800 bg-zinc-950 text-indigo-600 focus:ring-indigo-500" />
            <label for="is_recurring" class="ml-2 text-sm text-zinc-300">{% trans "Recurring task" %}</label>
          </div>

          <div id="recurring-options" class="hidden space-y-3">
            <div>
              <label class="block text-xs text-zinc-400 mb-2">{% trans "Frequency" %}</label>
              <select name="recurrence_frequency" class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="WEEKLY">{% trans "Weekly" %}</option>
                <option value="MONTHLY">{% trans "Monthly" %}</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-zinc-400 mb-2">{% trans "Interval" %}</label>
              <input name="recurrence_interval" type="number" min="1" value="1"
                     class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="block text-xs text-zinc-400 mb-2">{% trans "End date" %}</label>
              <input name="recurrence_end_date" type="date"
                     class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <div>
              <label class="block text-xs text-zinc-400 mb-2">{% trans "Max occurrences" %}</label>
              <input name="recurrence_max_occurrences" type="number" min="1"
                     class="w-full rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
          </div>
        </div>

        <button type="submit" class="w-full rounded-lg bg-indigo-600 hover:bg-indigo-500 transition px-3 py-2 font-medium">
          {% trans "Add task" %}
        </button>
      </form>
    {% endif %}

    <div class="mt-8 border-t border-zinc-800/70 pt-5">
      <div class="text-sm text-zinc-400">{% trans "Time overview" %}</div>

      {% if active_project %}
        <div class="mt-3 flex items-center justify-between text-sm">
          <div class="text-zinc-300">{% trans "Total tracked" %}</div>
          <div class="text-zinc-200 font-medium">{{ active_project_total_human }}</div>
        </div>

        <div class="mt-4 text-xs text-zinc-400">{% trans "Top tasks" %}</div>
        <div class="mt-2 space-y-2">
          {% for t in active_project_top_tasks %}
            <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/20 px-3 py-2">
              <div class="flex items-center justify-between gap-2">
                <div class="text-sm text-zinc-200 truncate">{{ t.title }}</div>
                <div class="text-xs text-zinc-400 font-mono">{{ t.tracked_human }}</div>
              </div>
            </div>
          {% empty %}
            <div class="mt-2 text-sm text-zinc-500">{% trans "No tracked time yet." %}</div>
          {% endfor %}
        </div>
      {% else %}
        <div class="mt-3 space-y-2">
          {% for row in project_time_overview %}
            <a class="block rounded-lg border border-zinc-800/70 bg-zinc-950/20 px-3 py-2 hover:bg-zinc-950/35 transition"
               href="?view={{ active_view }}&project={{ row.project_id }}">
              <div class="flex items-center justify-between gap-2">
                <div class="text-sm text-zinc-200 truncate">{{ row.project_title }}</div>
                <div class="text-xs text-zinc-400 font-mono">{{ row.total_human }}</div>
              </div>
            </a>
          {% empty %}
            <div class="mt-2 text-sm text-zinc-500">{% trans "No tracked time yet." %}</div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="rounded-2xl border border-zinc-800/70 bg-zinc-900/20 overflow-hidden">
      <div class="px-5 py-4 border-b border-zinc-800/70 flex items-center justify-between">
        <div class="text-sm text-zinc-200 font-medium">{% trans "Todo" %}</div>
        <div class="text-xs text-zinc-500">{{ todo_tasks|length }}</div>
      </div>
      <div id="col-todo" class="p-4 space-y-3 min-h-[200px]" data-kanban-column="1" data-status="TODO">
        {% for task in todo_tasks %}
          {% include "web/app/tasks/_task_card.html" with task=task members=members running_task_ids=running_task_ids %}
        {% empty %}
          <div data-empty-placeholder="true" class="rounded-xl border border-dashed border-zinc-800 bg-zinc-950/20 p-4 text-sm text-zinc-400">{% trans "Drop tasks here" %}</div>
        {% endfor %}
      </div>
    </div>

    <div class="rounded-2xl border border-zinc-800/70 bg-zinc-900/20 overflow-hidden">
      <div class="px-5 py-4 border-b border-zinc-800/70 flex items-center justify-between">
        <div class="text-sm text-zinc-200 font-medium">{% trans "In progress" %}</div>
        <div class="text-xs text-zinc-500">{{ in_progress_tasks|length }}</div>
      </div>
      <div id="col-inprogress" class="p-4 space-y-3 min-h-[200px]" data-kanban-column="1" data-status="IN_PROGRESS">
        {% for task in in_progress_tasks %}
          {% include "web/app/tasks/_task_card.html" with task=task members=members running_task_ids=running_task_ids %}
        {% empty %}
          <div data-empty-placeholder="true" class="rounded-xl border border-dashed border-zinc-800 bg-zinc-950/20 p-4 text-sm text-zinc-400">{% trans "Drop tasks here" %}</div>
        {% endfor %}
      </div>
    </div>

    <div class="rounded-2xl border border-zinc-800/70 bg-zinc-900/20 overflow-hidden">
      <div class="px-5 py-4 border-b border-zinc-800/70 flex items-center justify-between">
        <div class="text-sm text-zinc-200 font-medium">{% trans "Done" %}</div>
        <div class="text-xs text-zinc-500">{{ done_total_human }} · {{ done_tasks|length }}</div>
      </div>
      <div id="col-done" class="p-4 space-y-3 min-h-[200px]" data-kanban-column="1" data-status="DONE">
        {% for task in done_tasks %}
          {% include "web/app/tasks/_task_card.html" with task=task members=members running_task_ids=running_task_ids %}
        {% empty %}
          <div data-empty-placeholder="true" class="rounded-xl border border-dashed border-zinc-800 bg-zinc-950/20 p-4 text-sm text-zinc-400">{% trans "Drop tasks here" %}</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
  function formatDuration(totalSeconds) {
    const s = Math.max(0, Math.floor(totalSeconds));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if (h > 0) return `${h}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    return `${m}:${String(sec).padStart(2, '0')}`;
  }

  function initLiveTimers(root) {
    const scope = root || document;
    scope.querySelectorAll('[data-task-id]')?.forEach((card) => {
      const startedAt = card.dataset.runningStartedAt;
      const liveEl = card.querySelector('[data-live-timer]');
      if (!liveEl) return;

      if (!startedAt) {
        liveEl.textContent = '';
        liveEl.classList.add('hidden');
        return;
      }

      const startMs = Date.parse(startedAt);
      if (!Number.isFinite(startMs)) {
        liveEl.textContent = '';
        liveEl.classList.add('hidden');
        return;
      }

      liveEl.classList.remove('hidden');

      const tick = () => {
        const seconds = (Date.now() - startMs) / 1000;
        liveEl.textContent = formatDuration(seconds);
      };

      tick();
      clearInterval(card._timerInterval);
      card._timerInterval = setInterval(tick, 1000);
    });
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  function showToast(message) {
    const el = document.getElementById('toast');
    if (!el) return;
    el.textContent = message;
    el.classList.remove('opacity-0', 'pointer-events-none');
    el.classList.add('opacity-100');
    clearTimeout(el._hideTimer);
    el._hideTimer = setTimeout(() => {
      el.classList.add('opacity-0', 'pointer-events-none');
      el.classList.remove('opacity-100');
    }, 2200);
  }

  function getTaskIndexInColumn(columnEl, cardEl) {
    const cards = Array.from(columnEl.querySelectorAll('[data-task-id]'));
    return cards.indexOf(cardEl);
  }

  function insertTaskAtIndex(columnEl, cardEl, index) {
    const cards = Array.from(columnEl.querySelectorAll('[data-task-id]')).filter((el) => el !== cardEl);
    const clamped = Math.max(0, Math.min(index, cards.length));
    const before = cards[clamped] || null;
    columnEl.insertBefore(cardEl, before);
  }

  async function postMove(cardEl, columnEl, position) {
    const status = columnEl.dataset.status;
    const url = cardEl.dataset.moveUrl;

    const body = new URLSearchParams();
    body.set('status', status);
    body.set('position', String(position));

    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
        'X-CSRFToken': getCookie('csrftoken'),
      },
      body,
    });

    if (res.ok) {
      const html = await res.text();
      if (html) {
        // Replace card with updated HTML from server (includes new buttons/labels)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        const newCard = tempDiv.firstElementChild;
        if (newCard) {
          cardEl.replaceWith(newCard);
          // Re-initialize UI components on the new card
          initTasksUi(newCard);
        }
      }
    }

    return res;
  }

  function initKanban() {
    document.querySelectorAll('[data-kanban-column]')?.forEach((col) => {
      if (col._sortableInitialized) return;
      col._sortableInitialized = true;

      new Sortable(col, {
        group: 'tasks',
        draggable: '[data-task-id]',
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'opacity-50',
        onStart: (evt) => {
          const cardEl = evt.item;
          cardEl._fromCol = evt.from;
          cardEl._fromIndex = getTaskIndexInColumn(evt.from, cardEl);
        },
        onEnd: async (evt) => {
          const cardEl = evt.item;
          const columnEl = evt.to;
          const position = getTaskIndexInColumn(columnEl, cardEl);
          try {
            const res = await postMove(cardEl, columnEl, position);
            if (!res.ok) throw new Error('move_failed');
          } catch (e) {
            if (cardEl._fromCol) {
              insertTaskAtIndex(cardEl._fromCol, cardEl, cardEl._fromIndex ?? 0);
            }
            showToast('{% trans "Could not move task. Please try again." %}');
          }
        }
      });
    });
  }

  function initTasksUi(root) {
    initKanban();
    initLiveTimers(root || document);

    document.querySelectorAll('[data-kanban-column][data-status]')?.forEach((col) => {
      const hasCards = col.querySelector('[data-task-id]');
      if (!hasCards) return;
      col.querySelectorAll('[data-empty-placeholder="true"]')?.forEach((el) => el.remove());
    });
  }

  document.body.addEventListener('click', (evt) => {
    const card = evt.target.closest('[data-task-id]');
    if (!card) return;

    // Don't hijack clicks on interactive elements inside the card.
    if (evt.target.closest('a,button,select,input,textarea,label,summary')) return;

    const url = card.dataset.openUrl;
    if (url) window.location.href = url;
  });

  document.addEventListener('DOMContentLoaded', () => initTasksUi(document));
  document.body.addEventListener('htmx:load', (evt) => initTasksUi(evt.target));
  document.body.addEventListener('htmx:afterSwap', (evt) => initTasksUi(evt.target));

  document.body.addEventListener('htmx:responseError', (evt) => {
    const form = evt.detail.elt;
    if (form.id !== 'task-create-form') return;
    
    const errorBox = document.getElementById('task-error-message');
    if (!errorBox) return;
    
    try {
      const response = JSON.parse(evt.detail.xhr.responseText);
      if (response.error) {
        errorBox.textContent = response.error;
        errorBox.classList.remove('hidden');
        setTimeout(() => {
          errorBox.classList.add('hidden');
        }, 5000);
      }
    } catch (e) {
      errorBox.textContent = '{% trans "Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut." %}';
      errorBox.classList.remove('hidden');
      setTimeout(() => {
        errorBox.classList.add('hidden');
      }, 5000);
    }
  });

  document.body.addEventListener('htmx:afterRequest', (evt) => {
    const form = evt.detail.elt;
    if (form.id !== 'task-create-form') return;
    
    if (evt.detail.successful) {
      const errorBox = document.getElementById('task-error-message');
      if (errorBox) {
        errorBox.classList.add('hidden');
      }
    }
  });

  document.body.addEventListener('taskCreated', (evt) => {
    const detail = evt.detail || {};
    const taskId = detail.task_id;
    if (!taskId) return;

    // If the card wasn't inserted (for any reason), do an automatic reload once.
    const exists = document.querySelector(`[data-task-id="${taskId}"]`);
    if (exists) return;

    if (window.__pm_task_created_reload_done) return;
    window.__pm_task_created_reload_done = true;
    window.location.reload();
  });

  // Recurring task options toggle
  document.getElementById('is_recurring').addEventListener('change', (evt) => {
    const options = document.getElementById('recurring-options');
    if (evt.target.checked) {
      options.classList.remove('hidden');
    } else {
      options.classList.add('hidden');
    }
  });

  document.body.addEventListener('taskStatusChanged', async (evt) => {
    const detail = evt.detail || {};
    const taskId = detail.task_id;
    const newStatus = detail.new_status;
    if (!taskId || !newStatus) return;

    const card = document.querySelector(`[data-task-id="${taskId}"]`);
    const targetCol = document.querySelector(`[data-status="${newStatus}"]`);
    if (card && targetCol) {
      const sourceCol = card.parentElement;
      targetCol.prepend(card);
      try {
        const res = await postMove(card, targetCol, 0);
        if (!res.ok) throw new Error('move_failed');
      } catch (e) {
        if (sourceCol) sourceCol.prepend(card);
        showToast('{% trans "Could not move task. Please try again." %}');
      }
    }
  });

  // Bulk selection functionality
  let bulkMode = false;
  const bulkActionsBar = document.getElementById('bulk-actions-bar');
  const bulkSelectToggle = document.getElementById('bulk-select-toggle');
  const bulkCount = document.getElementById('bulk-count');
  const bulkApply = document.getElementById('bulk-apply');
  const bulkCancel = document.getElementById('bulk-cancel');
  const selectedTasks = new Set();

  function updateBulkUI() {
    const count = selectedTasks.size;
    bulkCount.textContent = `{% trans "${count} tasks selected" %}`.replace('${count}', count);
    bulkApply.disabled = count === 0;

    if (count > 0) {
      bulkActionsBar.classList.remove('translate-y-full');
    } else {
      bulkActionsBar.classList.add('translate-y-full');
    }
  }

  function toggleBulkMode() {
    bulkMode = !bulkMode;
    const checkboxes = document.querySelectorAll('.task-checkbox');
    const selectBtn = document.getElementById('bulk-select-toggle');

    if (bulkMode) {
      checkboxes.forEach(cb => cb.classList.remove('opacity-0', 'pointer-events-none'));
      selectBtn.textContent = '{% trans "Cancel" %}';
      selectedTasks.clear();
      updateBulkUI();
    } else {
      checkboxes.forEach(cb => cb.classList.add('opacity-0', 'pointer-events-none'));
      selectBtn.textContent = '{% trans "Select" %}';
      selectedTasks.clear();
      updateBulkUI();
    }
  }

  bulkSelectToggle.addEventListener('click', toggleBulkMode);
  bulkCancel.addEventListener('click', toggleBulkMode);

  document.addEventListener('change', (evt) => {
    if (evt.target.classList.contains('task-checkbox')) {
      const taskId = evt.target.dataset.taskId;
      if (evt.target.checked) {
        selectedTasks.add(taskId);
      } else {
        selectedTasks.delete(taskId);
      }
      updateBulkUI();
    }
  });

  bulkApply.addEventListener('click', async () => {
    const status = document.getElementById('bulk-status').value;
    const assignee = document.getElementById('bulk-assignee').value;
    const priority = document.getElementById('bulk-priority').value;

    if (!status && !assignee && !priority) return;

    const updates = [];
    if (status) updates.push(`status=${status}`);
    if (assignee) updates.push(`assigned_to=${assignee}`);
    if (priority) updates.push(`priority=${priority}`);

    for (const taskId of selectedTasks) {
      try {
        const url = `/web/tasks/${taskId}/update/`;
        const body = new URLSearchParams(updates.join('&'));
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body,
        });
        if (res.ok) {
          // Update the card in place
          const card = document.querySelector(`[data-task-id="${taskId}"]`);
          if (card) {
            const html = await res.text();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const newCard = tempDiv.firstElementChild;
            if (newCard) card.replaceWith(newCard);
          }
        }
      } catch (e) {
        console.error('Failed to update task', taskId, e);
      }
    }

    selectedTasks.clear();
    updateBulkUI();
    showToast('{% trans "Tasks updated successfully" %}');
  });

  // Filters functionality
  const filtersToggle = document.getElementById('filters-toggle');
  const filtersPanel = document.getElementById('filters-panel');
  const activeFilters = document.getElementById('active-filters');
  const applyFilters = document.getElementById('apply-filters');
  const clearFilters = document.getElementById('clear-filters');

  filtersToggle.addEventListener('click', () => {
    filtersPanel.classList.toggle('hidden');
  });

  applyFilters.addEventListener('click', () => {
    // For now, just hide the panel. Backend filtering would need API endpoints
    filtersPanel.classList.add('hidden');
    showToast('{% trans "Filters applied (frontend only for now)" %}');
  });

  clearFilters.addEventListener('click', () => {
    document.querySelectorAll('#filters-panel select, #filters-panel input').forEach(el => {
      if (el.type === 'date') el.value = '';
      else el.selectedIndex = -1;
    });
    activeFilters.innerHTML = '';
    activeFilters.classList.add('hidden');
  });

  // Search functionality (basic client-side for now)
  const searchInput = document.getElementById('task-search');
  searchInput.addEventListener('input', (evt) => {
    const query = evt.target.value.toLowerCase();
    document.querySelectorAll('[data-task-id]').forEach(card => {
      const title = card.textContent.toLowerCase();
      const shouldShow = !query || title.includes(query);
      card.style.display = shouldShow ? '' : 'none';
    });
  });

  // Task card expand/collapse functionality
  document.body.addEventListener('click', (evt) => {
    const expandBtn = evt.target.closest('.expand-btn');
    if (!expandBtn) return;

    evt.stopPropagation(); // Prevent card click

    const card = expandBtn.closest('.task-card');
    const expandedContent = card.querySelector('.expanded-content');
    const isExpanded = expandBtn.dataset.expanded === 'true';

    if (isExpanded) {
      expandedContent.classList.add('hidden');
      expandBtn.dataset.expanded = 'false';
      expandBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>`;
    } else {
      expandedContent.classList.remove('hidden');
      expandBtn.dataset.expanded = 'true';
      expandBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
      </svg>`;
    }
  });
</script>

<!-- Bulk actions bar -->
<div id="bulk-actions-bar" class="fixed bottom-0 left-0 right-0 bg-zinc-900 border-t border-zinc-800 p-4 transform translate-y-full transition-transform duration-200">
  <div class="flex items-center justify-between max-w-7xl mx-auto">
    <span id="bulk-count" class="text-sm text-zinc-300">0 tasks selected</span>
    <div class="flex gap-2">
      <select id="bulk-status" class="rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm">
        <option value="">{% trans "Change Status" %}</option>
        <option value="TODO">{% trans "Todo" %}</option>
        <option value="IN_PROGRESS">{% trans "In Progress" %}</option>
        <option value="DONE">{% trans "Done" %}</option>
      </select>
      <select id="bulk-assignee" class="rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm">
        <option value="">{% trans "Assign To" %}</option>
        {% for m in members %}
          <option value="{{ m.user.id }}">{{ m.user.email }}</option>
        {% endfor %}
      </select>
      <select id="bulk-priority" class="rounded-lg bg-zinc-950 border border-zinc-800 px-3 py-2 text-sm">
        <option value="">{% trans "Set Priority" %}</option>
        <option value="HIGH">{% trans "High" %}</option>
        <option value="MEDIUM">{% trans "Medium" %}</option>
        <option value="LOW">{% trans "Low" %}</option>
      </select>
      <button id="bulk-apply" class="rounded-lg bg-indigo-600 hover:bg-indigo-500 px-4 py-2 text-sm disabled:opacity-50" disabled>{% trans "Apply" %}</button>
      <button id="bulk-cancel" class="rounded-lg border border-zinc-800 bg-zinc-900 px-4 py-2 text-sm hover:bg-zinc-800">{% trans "Cancel" %}</button>
    </div>
  </div>
</div>

<div id="toast"
     class="fixed bottom-4 left-1/2 -translate-x-1/2 rounded-xl border border-zinc-800 bg-zinc-950/90 px-4 py-2 text-sm text-zinc-200 shadow-lg opacity-0 pointer-events-none transition-opacity">
</div>
{% endblock %}
